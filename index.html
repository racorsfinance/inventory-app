<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventory Tracker v1.7</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">

<!-- Firebase (COMPAT version for normal HTML usage) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
header{background:#2c3e50;color:#fff;padding:12px;text-align:center}
nav{display:flex;background:#34495e}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff}
nav button.active{background:#1abc9c}
section{display:none;padding:12px}
section.active{display:block}
input,select,textarea,button{width:100%;padding:9px;margin:6px 0}
button.primary{background:#1abc9c;color:#fff;border:none}
button.warn{background:#e74c3c;color:#fff;border:none}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:6px}
.status-list{max-height:260px;overflow-y:auto}
.status-row{display:flex;justify-content:space-between;padding:8px;border-radius:4px;margin-bottom:6px}
.ok{background:#d4efdf}
.warnlvl{background:#fcf3cf}
.crit{background:#f5b7b1}
.badge{background:#f8d7da;color:#721c24;padding:10px;border-radius:6px;margin-bottom:12px}
.chart-wrap{width:100%;overflow-x:auto}
canvas{display:block}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:10}
.modal-content{background:#fff;margin:8% auto;padding:15px;width:92%;max-width:420px;border-radius:6px}
</style>
</head>

<body>

<header><h2>Inventory Tracker</h2></header>

<div id="authBar" style="padding:6px;text-align:right;background:#ecf0f1">
  <span id="userInfo">Not logged in</span>
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>
</div>

<nav>
<button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
<button onclick="showTab('items',this)">Item Master</button>
<button onclick="showTab('logs',this)">Stock Log</button>
<button onclick="showTab('reports',this)">Reports</button>
<button onclick="showTab('data',this)">Data / Backup & Restore</button>
</nav>

<!-- DASHBOARD -->
<section id="dashboard" class="active">
<h3>Dashboard</h3>

<select id="dashMonth" onchange="renderDashboard()"></select>
<select id="dashYear" onchange="renderDashboard()"></select>

<div id="criticalBadge"></div>

<div class="card">
<h4>Item Status</h4>
<div class="status-list" id="itemStatusList"></div>
</div>

<div class="card">
<h4>Monthly In / Out</h4>
<div class="chart-wrap">
<canvas id="consumptionChart" height="260"></canvas>
</div>
</div>
</section>

<!-- ITEMS -->
<section id="items">
<h3>Add Item</h3>
<input id="itemName" placeholder="Item Name">
<input id="openingStock" type="number" placeholder="Opening Stock">
<input id="minStock" type="number" placeholder="Minimum Stock">
<input id="uom" placeholder="Unit (PCS/KG)">
<button class="primary" onclick="addItem()">Add Item</button>
<div id="itemList"></div>
</section>

<!-- STOCK LOG -->
<section id="logs">
<h3>Stock Entry</h3>
<select id="logItem"></select>
<select id="logType">
<option value="in">Stock In</option>
<option value="out">Stock Out</option>
<option value="adj">Adjustment</option>
</select>
<input id="logQty" type="number" placeholder="Quantity">
<textarea id="logRef" placeholder="Remarks"></textarea>
<button class="primary" onclick="addLog()">Save Log</button>
<div id="logList"></div>
</section>

<!-- REPORT -->
<section id="reports">
<h3>Reports</h3>
<select id="repMonth"></select>
<select id="repYear"></select>
<button onclick="generateReport()">Generate</button>
<div id="reportView"></div>
</section>

<!-- DATA -->
<section id="data">
<h3>Backup & Restore</h3>
<button onclick="exportItemsCSV()">Export Items CSV</button>
<button onclick="exportLogsCSV()">Export Logs CSV</button>
<button onclick="exportAllCSV()">Export ALL CSV</button>
<button onclick="backupJSON()">Backup JSON</button>
<input type="file" onchange="restoreJSON(event)">
<button class="warn" onclick="resetAll()">RESET ALL DATA</button>
</section>

<script>

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBwvLHUwfI9c3aSWR2N46VmwRFL8ZRXWX4",
  authDomain: "inventory-tracker-1bc0a.firebaseapp.com",
  projectId: "inventory-tracker-1bc0a",
  storageBucket: "inventory-tracker-1bc0a.firebasestorage.app",
  messagingSenderId: "961763374661",
  appId: "1:961763374661:web:28a5065c62249d0f52d52c"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== DATA ===== */
let items = [];
let logs = [];

/* ===== AUTH ===== */
function login(){
 const provider = new firebase.auth.GoogleAuthProvider();
 auth.signInWithPopup(provider)
 .then(result=>{
   document.getElementById("userStatus").innerText =
   "Logged in: " + result.user.email;
 })
 .catch(err=>{
   alert("Login Error: "+err.message);
 });
}

function logout(){
 auth.signOut().then(()=>{
   document.getElementById("userStatus").innerText="Not logged in";
 });
}

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("userInfo").innerText = user.displayName || user.email;

    // ðŸ”¥ Real-time sync from Firebase
    db.collection("inventory").doc("mainData")
      .onSnapshot(doc=>{
        if(doc.exists){
          const data = doc.data();
          items = data.items || [];
          logs  = data.logs  || [];
          renderAll();
        } else {
          // first-time user case
          items = [];
          logs  = [];
          renderAll();
        }
      });

  } else {
    document.getElementById("userInfo").innerText = "Not logged in";
  }
});
/* ===== SAVE ===== */
function save(){
  if(auth.currentUser){
    db.collection("inventory").doc("mainData").set({
      items: items,
      logs: logs
    });
  }
}

/* ===== ITEMS ===== */
function addItem(){
  items.push({
    id: Date.now(),
    name: itemName.value,
    stock: +openingStock.value || 0,
    min: +minStock.value || 0,
    uom: uom.value || "PCS",
    status:"active"
  });

  itemName.value="";
  openingStock.value="";
  minStock.value="";
  uom.value="";

  save();
}

/* ===== STOCK LOG ===== */
function addLog(){
  let it = items.find(x=>x.id == logItem.value);
  let qty = +logQty.value;
  let change = (logType.value==="out") ? -qty : qty;

  it.stock += change;

  logs.push({
    ts:new Date().toISOString(),
    item:it.name,
    qty:qty,
    change:change,
    ref:logRef.value,
    uom:it.uom
  });

  logQty.value="";
  logRef.value="";

  save();
}

/* ===== RENDER ===== */
function renderItems(){
  itemList.innerHTML="";
  logItem.innerHTML="";
  items.forEach(i=>{
    itemList.innerHTML += `<div class="card"><b>${i.name}</b> - ${i.stock} ${i.uom}</div>`;
    logItem.innerHTML += `<option value="${i.id}">${i.name}</option>`;
  });
}

function renderLogs(){
  logList.innerHTML="";
  logs.slice().reverse().forEach(l=>{
    logList.innerHTML += `<div class="card">
      ${new Date(l.ts).toLocaleString()}<br>
      ${l.item} (${l.change})<br>
      ${l.ref||""}
    </div>`;
  });
}

/* ===== DASHBOARD ===== */
function renderDashboard(){
  let html="";
  let critical=[];

  items.forEach(i=>{
    let cls="ok";
    if(i.stock <= i.min) cls="crit";
    else if(i.stock <= i.min+5) cls="warnlvl";

    html+=`<div class="status-row ${cls}">
      <span>${i.name}</span>
      <span>${i.stock} / ${i.min}</span>
    </div>`;

    if(cls==="crit"){
      critical.push(`${i.name} (${i.stock}/${i.min})`);
    }
  });

  itemStatusList.innerHTML=html;

  if(critical.length){
    criticalBadge.innerHTML = `<div class="badge">âš  Low Stock: ${critical.join(", ")}</div>`;
  } else {
    criticalBadge.innerHTML="";
  }
}

/* ===== REPORT ===== */
function generateReport(){
  reportView.innerHTML = logs.map(l=>`
    ${new Date(l.ts).toLocaleDateString()} - ${l.item} ${l.qty}<br>
  `).join("");
}

/* ===== CSV ===== */
function exportItemsCSV(){
  let rows=[["Item","Stock","Min"]];
  items.forEach(i=>rows.push([i.name,i.stock,i.min]));
  downloadCSV("items.csv",rows);
}

function exportLogsCSV(){
  let rows=[["Date","Item","Qty","Remarks"]];
  logs.forEach(l=>rows.push([l.ts,l.item,l.qty,l.ref]));
  downloadCSV("logs.csv",rows);
}

function exportAllCSV(){
  let rows=[["ITEMS"],[],["Name","Stock"]];
  items.forEach(i=>rows.push([i.name,i.stock]));
  rows.push([],["LOGS"]);
  logs.forEach(l=>rows.push([l.ts,l.item,l.qty,l.ref]));
  downloadCSV("all.csv",rows);
}

function downloadCSV(name,rows){
  let csv=rows.map(r=>r.join(",")).join("\n");
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download=name;
  a.click();
}

/* ===== BACKUP / RESTORE ===== */
function backupJSON(){
  let blob=new Blob([JSON.stringify({items,logs})]);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup.json";
  a.click();
}

function restoreJSON(e){
  let file=e.target.files[0];
  let r=new FileReader();
  r.onload=()=>{
    let d=JSON.parse(r.result);
    items=d.items||[];
    logs=d.logs||[];
    save();
  };
  r.readAsText(file);
}

function resetAll(){
  if(confirm("Reset all data?")){
    items=[];
    logs=[];
    save();
  }
}

/* ===== NAV ===== */
function showTab(id,btn){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));

 document.getElementById(id).classList.add("active");
 btn.classList.add("active");
}

/* ===== INIT ===== */
function renderAll(){
  renderItems();
  renderLogs();
  renderDashboard();
}

</script>

<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>