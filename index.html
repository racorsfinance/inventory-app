<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventory Tracker v1.7.1</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">

<!-- Firebase (COMPAT version) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
header{background:#2c3e50;color:#fff;padding:12px;text-align:center}
nav{display:flex;background:#34495e}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff}
nav button.active{background:#1abc9c}
section{display:none;padding:12px}
section.active{display:block}
input,select,textarea,button{width:100%;padding:9px;margin:6px 0}
button.primary{background:#1abc9c;color:#fff;border:none}
button.warn{background:#e74c3c;color:#fff;border:none}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:6px}
.status-list{max-height:260px;overflow-y:auto}
.status-row{display:flex;justify-content:space-between;padding:8px;border-radius:4px;margin-bottom:6px}
.ok{background:#d4efdf}
.warnlvl{background:#fcf3cf}
.crit{background:#f5b7b1}
.badge{background:#f8d7da;color:#721c24;padding:10px;border-radius:6px;margin-bottom:12px}
</style>
</head>

<body>

<header><h2>Inventory Tracker</h2></header>

<div id="authBar" style="padding:6px;text-align:right;background:#ecf0f1">
  <span id="userInfo">Not logged in</span>
  <button onclick="login()">Login</button>
  <button onclick="logout()">Logout</button>
</div>

<nav>
<button class="active" onclick="showTab('dashboard',this)">Dashboard</button>
<button onclick="showTab('items',this)">Item Master</button>
<button onclick="showTab('logs',this)">Stock Log</button>
<button onclick="showTab('reports',this)">Reports</button>
<button onclick="showTab('data',this)">Data / Backup & Restore</button>
</nav>

<!-- DASHBOARD -->
<section id="dashboard" class="active">
<h3>Dashboard</h3>

<div id="criticalBadge"></div>

<div class="card">
<h4>Item Status</h4>
<div class="status-list" id="itemStatusList"></div>
</div>
</section>

<!-- ITEMS -->
<section id="items">
<h3>Add Item</h3>
<input id="itemName" placeholder="Item Name">
<input id="openingStock" type="number" placeholder="Opening Stock">
<input id="minStock" type="number" placeholder="Minimum Stock">
<input id="uom" placeholder="Unit (PCS/KG)">
<button class="primary" onclick="addItem()">Add Item</button>
<div id="itemList"></div>
</section>

<!-- STOCK LOG -->
<section id="logs">
<h3>Stock Entry</h3>
<select id="logItem"></select>
<select id="logType">
<option value="in">Stock In</option>
<option value="out">Stock Out</option>
<option value="adj">Adjustment</option>
</select>
<input id="logQty" type="number" placeholder="Quantity">
<textarea id="logRef" placeholder="Remarks"></textarea>
<button class="primary" onclick="addLog()">Save Log</button>
<div id="logList"></div>
</section>

<!-- REPORT -->
<section id="reports">
<h3>Reports</h3>
<button onclick="generateReport()">Generate</button>
<div id="reportView"></div>
</section>

<!-- DATA -->
<section id="data">
<h3>Backup & Restore</h3>
<button onclick="exportItemsCSV()">Export Items CSV</button>
<button onclick="exportLogsCSV()">Export Logs CSV</button>
<button onclick="exportAllCSV()">Export ALL CSV</button>
<button onclick="backupJSON()">Backup JSON</button>
<input type="file" onchange="restoreJSON(event)">
<button class="warn" onclick="resetAll()">RESET ALL DATA</button>
</section>

<script>

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBwvLHUwfI9c3aSWR2N46VmwRFL8ZRXWX4",
  authDomain: "inventory-tracker-1bc0a.firebaseapp.com",
  projectId: "inventory-tracker-1bc0a",
  storageBucket: "inventory-tracker-1bc0a.firebasestorage.app",
  messagingSenderId: "961763374661",
  appId: "1:961763374661:web:28a5065c62249d0f52d52c"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
auth.getRedirectResult().then(result=>{
  if(result.user){
    console.log("Login success:", result.user.email);
  }
}).catch(err=>{
  alert("Login Error: " + err.message);
});

/* DATA */
let items = [];
let logs = [];

/* AUTH */
function login(){
 const provider = new firebase.auth.GoogleAuthProvider();
 auth.signInWithRedirect(provider);
}
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("userInfo").innerText = user.email;

    db.collection("inventory").doc("mainData")
    .onSnapshot(doc=>{
      if(doc.exists){
        const d = doc.data();
        items = d.items || [];
        logs = d.logs || [];
        renderAll();
      }
    });
  } else {
    document.getElementById("userInfo").innerText = "Not logged in";
  }
});

/* SAVE */
function save(){
  if(auth.currentUser){
    db.collection("inventory").doc("mainData").set({items,logs});
  }
}

/* ITEMS */
function addItem(){
 items.push({
  id:Date.now(),
  name:itemName.value,
  stock:+openingStock.value||0,
  min:+minStock.value||0,
  uom:uom.value||"PCS"
 });
 itemName.value=""; openingStock.value=""; minStock.value=""; uom.value="";
 save();
}

/* LOG */
function addLog(){
 let it = items.find(x=>x.id==logItem.value);
 let qty = +logQty.value;
 let change = logType.value==="out" ? -qty : qty;

 it.stock += change;

 logs.push({
  ts:new Date().toISOString(),
  item:it.name,
  qty:qty,
  change:change,
  ref:logRef.value
 });

 logQty.value=""; logRef.value="";
 save();
}

/* RENDER */
function renderItems(){
 itemList.innerHTML="";
 logItem.innerHTML="";
 items.forEach(i=>{
  itemList.innerHTML+=`<div class="card">${i.name} - ${i.stock}</div>`;
  logItem.innerHTML+=`<option value="${i.id}">${i.name}</option>`;
 });
}

function renderLogs(){
 logList.innerHTML="";
 logs.slice().reverse().forEach(l=>{
  logList.innerHTML+=`<div class="card">
   ${new Date(l.ts).toLocaleString()}<br>
   ${l.item} (${l.change})<br>${l.ref||""}
  </div>`;
 });
}

function renderDashboard(){
 let html="";
 let critical=[];

 items.forEach(i=>{
  let cls="ok";
  if(i.stock<=i.min) cls="crit";
  else if(i.stock<=i.min+5) cls="warnlvl";

  html+=`<div class="status-row ${cls}">
   <span>${i.name}</span>
   <span>${i.stock}/${i.min}</span>
  </div>`;

  if(cls==="crit") critical.push(i.name);
 });

 itemStatusList.innerHTML=html;

 criticalBadge.innerHTML = critical.length
  ? `<div class="badge">âš  Low Stock: ${critical.join(", ")}</div>`
  : "";
}

/* REPORT */
function generateReport(){
 reportView.innerHTML = logs.map(l=>`
  ${new Date(l.ts).toLocaleDateString()} - ${l.item} (${l.qty}) - ${l.ref||""}
 `).join("<br>");
}

/* CSV */
function exportItemsCSV(){
 downloadCSV("items.csv",[["Item","Stock","Min"],...items.map(i=>[i.name,i.stock,i.min])]);
}
function exportLogsCSV(){
 downloadCSV("logs.csv",[["Date","Item","Qty","Remarks"],...logs.map(l=>[l.ts,l.item,l.qty,l.ref])]);
}
function exportAllCSV(){
 let rows=[["ITEMS"],["Name","Stock"]];
 items.forEach(i=>rows.push([i.name,i.stock]));
 rows.push(["LOGS"]);
 logs.forEach(l=>rows.push([l.ts,l.item,l.qty,l.ref]));
 downloadCSV("all.csv",rows);
}
function downloadCSV(name,rows){
 let csv=rows.map(r=>r.join(",")).join("\n");
 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download=name;
 a.click();
}

/* BACKUP */
function backupJSON(){
 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([JSON.stringify({items,logs})]));
 a.download="backup.json";
 a.click();
}
function restoreJSON(e){
 let f=e.target.files[0];
 let r=new FileReader();
 r.onload=()=>{
  let d=JSON.parse(r.result);
  items=d.items||[];
  logs=d.logs||[];
  save();
 };
 r.readAsText(f);
}
function resetAll(){
 if(confirm("Reset all data?")){
  items=[]; logs=[];
  save();
 }
}

/* NAV */
function showTab(id,btn){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 btn.classList.add("active");
}

function renderAll(){
 renderItems();
 renderLogs();
 renderDashboard();
}

</script>

<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>

